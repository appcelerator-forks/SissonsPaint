var cacheManager=Titanium.App.Properties.getObject("cachedXHRDocuments",{});XHR=function(){},XHR.prototype.get=function(e,t,i,r){Titanium.API.info(e);var t=t||function(){},i=i||function(){},r=r||{};r.async=r.hasOwnProperty("async")?r.async:!0,r.ttl=r.ttl||!1,r.shouldAuthenticate=r.shouldAuthenticate||!1,r.contentType=r.contentType||"application/json";var o=readCache(e);if(r.ttl&&0!=o){var n={};n.status="cache",n.data=o,t(n)}else{var a=Titanium.Network.createHTTPClient({enableKeepAlive:!1}),n={};if(a.setRequestHeader("Content-Type",r.contentType),a.open("GET",e,r.async),r.shouldAuthenticate){var l="Basic "+Titanium.Utils.base64encode(r.username+":"+r.password);a.setRequestHeader("Authorization",l)}a.onload=function(){n.status=200==a.status?"ok":a.status,n.data=-1!=r.contentType.indexOf("application/json")?a.responseText:-1!=r.contentType.indexOf("text/xml")?a.responseXML:a.responseData,t(n),writeCache(n.data,e,r.ttl)},a.onerror=function(e){n.status="error",n.data=e,n.code=a.status,i(n)},a.send()}},XHR.prototype.post=function(e,t,i,r,o){Titanium.API.info(e+" "+JSON.stringify(t));var i=i||function(){},r=r||function(){},o=o||{};o.async=o.hasOwnProperty("async")?o.async:!0,o.shouldAuthenticate=o.shouldAuthenticate||!1,o.contentType=o.contentType||"application/json";var n=Titanium.Network.createHTTPClient({enableKeepAlive:!1}),a={};if(n.open("POST",e,o.async),n.setRequestHeader("Content-Type",o.contentType),o.shouldAuthenticate){var l="Basic "+Titanium.Utils.base64encode(o.username+":"+o.password);n.setRequestHeader("Authorization",l)}n.onload=function(){a.status=200==n.status?"ok":n.status,a.data=n.responseText,i(a)},n.onerror=function(e){a.status="error",a.data=e.error,a.code=n.status,r(a)},n.send(t)},XHR.prototype.put=function(e,t,i,r,o){var i=i||function(){},r=r||function(){},o=o||{};o.async=o.hasOwnProperty("async")?o.async:!0,o.shouldAuthenticate=o.shouldAuthenticate||!1,o.contentType=o.contentType||"application/json";var n=Titanium.Network.createHTTPClient({enableKeepAlive:!1}),a={};if(n.open("PUT",e,o.async),n.setRequestHeader("Content-Type",o.contentType),o.shouldAuthenticate){var l="Basic "+Titanium.Utils.base64encode(o.username+":"+o.password);n.setRequestHeader("Authorization",l)}n.onload=function(){a.status=200==n.status?"ok":n.status,a.data=n.responseText,i(a)},n.onerror=function(e){a.status="error",a.data=e.error,a.code=n.status,r(a)},n.send(t)},XHR.prototype.destroy=function(e,t,i,r){Titanium.API.info(e);var t=t||function(){},i=i||function(){},r=r||{};r.async=r.hasOwnProperty("async")?r.async:!0,r.shouldAuthenticate=r.shouldAuthenticate||!1,r.contentType=r.contentType||"application/json";var o=Titanium.Network.createHTTPClient({enableKeepAlive:!1}),n={};if(o.open("DELETE",e,r.async),o.setRequestHeader("Content-Type",r.contentType),r.shouldAuthenticate){var a="Basic "+Titanium.Utils.base64encode(r.username+":"+r.password);o.setRequestHeader("Authorization",a)}o.onload=function(){n.status=200==o.status?"ok":o.status,n.data=o.responseText,t(n)},o.onerror=function(e){n.status="error",n.data=e.error,n.code=o.status,i(n)},o.send()},XHR.prototype.clear=function(e){if(e){var t=Titanium.Utils.md5HexDigest(e),i=cacheManager[t];if(i){var r=Titanium.Filesystem.getFile(Titanium.Filesystem.applicationDataDirectory,t);delete cacheManager[t],r.deleteFile(),updateCacheManager()}}},XHR.prototype.clean=function(){var e=(new Date).getTime(),t=0;for(var i in cacheManager){var r=cacheManager[i];if(r.timestamp<=e){var o=Titanium.Filesystem.getFile(Titanium.Filesystem.applicationDataDirectory,i);delete cacheManager[i],o.deleteFile(),updateCacheManager(),t+=1}}return t},XHR.prototype.purge=function(){var e=0;for(var t in cacheManager){cacheManager[t];var i=Titanium.Filesystem.getFile(Titanium.Filesystem.applicationDataDirectory,t);delete cacheManager[t],i.deleteFile(),updateCacheManager(),e+=1}return e},readCache=function(e){var t=Titanium.Utils.md5HexDigest(e),i=cacheManager[t],r=!1;if(i){var o=Titanium.Filesystem.getFile(Titanium.Filesystem.applicationDataDirectory,t);i.timestamp>=(new Date).getTime()?r=o.read():(delete cacheManager[t],o.deleteFile(),updateCacheManager())}return r},updateCacheManager=function(){Titanium.App.Properties.setObject("cachedXHRDocuments",cacheManager)},writeCache=function(e,t,i){var r=Titanium.Utils.md5HexDigest(t),o=Titanium.Filesystem.getFile(Titanium.Filesystem.applicationDataDirectory,r);o.write(e),cacheManager[r]={timestamp:(new Date).getTime()+60*i*1e3},updateCacheManager()},module.exports=XHR;