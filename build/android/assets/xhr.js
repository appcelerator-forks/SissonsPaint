var cacheManager=Titanium.App.Properties.getObject("cachedXHRDocuments",{});XHR=function(){},XHR.prototype.get=function(e,t,i,o){Titanium.API.info(e);var t=t||function(){},i=i||function(){},o=o||{};o.async=o.hasOwnProperty("async")?o.async:!0,o.ttl=o.ttl||!1,o.shouldAuthenticate=o.shouldAuthenticate||!1,o.contentType=o.contentType||"application/json";var r=readCache(e);if(o.ttl&&0!=r){var a={};a.status="cache",a.data=r,t(a)}else{var n=Titanium.Network.createHTTPClient({enableKeepAlive:!1}),a={};if(n.setRequestHeader("Content-Type",o.contentType),n.open("GET",e,o.async),o.shouldAuthenticate){var l="Basic "+Titanium.Utils.base64encode(o.username+":"+o.password);n.setRequestHeader("Authorization",l)}n.onload=function(){a.status=200==n.status?"ok":n.status,a.data=-1!=o.contentType.indexOf("application/json")?n.responseText:-1!=o.contentType.indexOf("text/xml")?n.responseXML:n.responseData,t(a),writeCache(a.data,e,o.ttl)},n.onerror=function(e){a.status="error",a.data=e,a.code=n.status,i(a)},n.send()}},XHR.prototype.post=function(e,t,i,o,r){Titanium.API.info(e+" "+JSON.stringify(t));var i=i||function(){},o=o||function(){},r=r||{};r.async=r.hasOwnProperty("async")?r.async:!0,r.shouldAuthenticate=r.shouldAuthenticate||!1,r.contentType=r.contentType||"application/json";var a=Titanium.Network.createHTTPClient({enableKeepAlive:!1}),n={};if(a.open("POST",e,r.async),a.setRequestHeader("Content-Type",r.contentType),r.shouldAuthenticate){var l="Basic "+Titanium.Utils.base64encode(r.username+":"+r.password);a.setRequestHeader("Authorization",l)}a.onload=function(){n.status=200==a.status?"ok":a.status,n.data=a.responseText,i(n)},a.onerror=function(e){n.status="error",n.data=e.error,n.code=a.status,o(n)},a.send(t)},XHR.prototype.put=function(e,t,i,o,r){var i=i||function(){},o=o||function(){},r=r||{};r.async=r.hasOwnProperty("async")?r.async:!0,r.shouldAuthenticate=r.shouldAuthenticate||!1,r.contentType=r.contentType||"application/json";var a=Titanium.Network.createHTTPClient({enableKeepAlive:!1}),n={};if(a.open("PUT",e,r.async),a.setRequestHeader("Content-Type",r.contentType),r.shouldAuthenticate){var l="Basic "+Titanium.Utils.base64encode(r.username+":"+r.password);a.setRequestHeader("Authorization",l)}a.onload=function(){n.status=200==a.status?"ok":a.status,n.data=a.responseText,i(n)},a.onerror=function(e){n.status="error",n.data=e.error,n.code=a.status,o(n)},a.send(t)},XHR.prototype.destroy=function(e,t,i,o){Titanium.API.info(e);var t=t||function(){},i=i||function(){},o=o||{};o.async=o.hasOwnProperty("async")?o.async:!0,o.shouldAuthenticate=o.shouldAuthenticate||!1,o.contentType=o.contentType||"application/json";var r=Titanium.Network.createHTTPClient({enableKeepAlive:!1}),a={};if(r.open("DELETE",e,o.async),r.setRequestHeader("Content-Type",o.contentType),o.shouldAuthenticate){var n="Basic "+Titanium.Utils.base64encode(o.username+":"+o.password);r.setRequestHeader("Authorization",n)}r.onload=function(){a.status=200==r.status?"ok":r.status,a.data=r.responseText,t(a)},r.onerror=function(e){a.status="error",a.data=e.error,a.code=r.status,i(a)},r.send()},XHR.prototype.clear=function(e){if(e){var t=Titanium.Utils.md5HexDigest(e),i=cacheManager[t];if(i){var o=Titanium.Filesystem.getFile(Titanium.Filesystem.applicationDataDirectory,t);delete cacheManager[t],o.deleteFile(),updateCacheManager()}}},XHR.prototype.clean=function(){var e=(new Date).getTime(),t=0;for(var i in cacheManager){var o=cacheManager[i];if(o.timestamp<=e){var r=Titanium.Filesystem.getFile(Titanium.Filesystem.applicationDataDirectory,i);delete cacheManager[i],r.deleteFile(),updateCacheManager(),t+=1}}return t},XHR.prototype.purge=function(){var e=0;for(var t in cacheManager){cacheManager[t];var i=Titanium.Filesystem.getFile(Titanium.Filesystem.applicationDataDirectory,t);delete cacheManager[t],i.deleteFile(),updateCacheManager(),e+=1}return e},readCache=function(e){var t=Titanium.Utils.md5HexDigest(e),i=cacheManager[t],o=!1;if(i){var r=Titanium.Filesystem.getFile(Titanium.Filesystem.applicationDataDirectory,t);i.timestamp>=(new Date).getTime()?o=r.read():(delete cacheManager[t],r.deleteFile(),updateCacheManager())}return o},updateCacheManager=function(){Titanium.App.Properties.setObject("cachedXHRDocuments",cacheManager)},writeCache=function(e,t,i){var o=Titanium.Utils.md5HexDigest(t),r=Titanium.Filesystem.getFile(Titanium.Filesystem.applicationDataDirectory,o);r.write(e),cacheManager[o]={timestamp:(new Date).getTime()+60*i*1e3},updateCacheManager()},module.exports=XHR;